import{i as V,e as F}from"./media-encoder-host-DqFeIMFh.js";import{a as $,c as J}from"./recorder-audio-worklet-BKRkq2ay.js";import{m as K,a as Q,b as U,c as q,d as X,e as Z}from"./standardized-audio-context-qOBlHMl5.js";import{M as I}from"./multi-buffer-data-view-IGXr9-7R.js";import{o as ee}from"./subscribable-things-Cegrwan0.js";const te=t=>(o,i)=>{if(t===null)throw new Error("A native BlobEvent could not be created.");return new t(o,i)},ne=(t,o)=>(i,s,a)=>{const l=[];let r=s,c=0;for(;c<i.byteLength;)if(r===null){const e=o(i,c);if(e===null)break;const{length:n,type:u}=e;r=u,c+=n}else{const e=t(i,c,r,a);if(e===null)break;const{content:n,length:u}=e;r=null,c+=u,n!==null&&l.push(n)}return{contents:l,currentElementType:r,offset:c}},re=(t,o)=>class{constructor(s=null){this._listeners=new WeakMap,this._nativeEventTarget=s===null?t():s}addEventListener(s,a,l){if(a!==null){let r=this._listeners.get(a);r===void 0&&(r=o(this,a),typeof a=="function"&&this._listeners.set(a,r)),this._nativeEventTarget.addEventListener(s,r,l)}}dispatchEvent(s){return this._nativeEventTarget.dispatchEvent(s)}removeEventListener(s,a,l){const r=a===null?void 0:this._listeners.get(a);this._nativeEventTarget.removeEventListener(s,r===void 0?null:r,l)}},se=t=>()=>{if(t===null)throw new Error("A native EventTarget could not be created.");return t.document.createElement("p")},oe=(t="")=>{try{return new DOMException(t,"InvalidModificationError")}catch(o){return o.code=13,o.message=t,o.name="InvalidModificationError",o}},ie=()=>{try{return new DOMException("","InvalidStateError")}catch(t){return t.code=11,t.name="InvalidStateError",t}},ae=(t,o,i,s,a,l,r)=>class extends l{constructor(e,n={}){const{mimeType:u}=n;if(r!==null&&(u===void 0||r.isTypeSupported!==void 0&&r.isTypeSupported(u))){const p=t(r,e,n);super(p),this._internalMediaRecorder=p}else if(u!==void 0&&a.some(p=>p.test(u)))super(),r!==null&&r.isTypeSupported!==void 0&&r.isTypeSupported("audio/webm;codecs=pcm")?this._internalMediaRecorder=s(this,r,e,u):this._internalMediaRecorder=i(this,e,u);else throw r!==null&&t(r,e,n),o();this._ondataavailable=null,this._onerror=null,this._onpause=null,this._onresume=null,this._onstart=null,this._onstop=null}get mimeType(){return this._internalMediaRecorder.mimeType}get ondataavailable(){return this._ondataavailable===null?this._ondataavailable:this._ondataavailable[0]}set ondataavailable(e){if(this._ondataavailable!==null&&this.removeEventListener("dataavailable",this._ondataavailable[1]),typeof e=="function"){const n=e.bind(this);this.addEventListener("dataavailable",n),this._ondataavailable=[e,n]}else this._ondataavailable=null}get onerror(){return this._onerror===null?this._onerror:this._onerror[0]}set onerror(e){if(this._onerror!==null&&this.removeEventListener("error",this._onerror[1]),typeof e=="function"){const n=e.bind(this);this.addEventListener("error",n),this._onerror=[e,n]}else this._onerror=null}get onpause(){return this._onpause===null?this._onpause:this._onpause[0]}set onpause(e){if(this._onpause!==null&&this.removeEventListener("pause",this._onpause[1]),typeof e=="function"){const n=e.bind(this);this.addEventListener("pause",n),this._onpause=[e,n]}else this._onpause=null}get onresume(){return this._onresume===null?this._onresume:this._onresume[0]}set onresume(e){if(this._onresume!==null&&this.removeEventListener("resume",this._onresume[1]),typeof e=="function"){const n=e.bind(this);this.addEventListener("resume",n),this._onresume=[e,n]}else this._onresume=null}get onstart(){return this._onstart===null?this._onstart:this._onstart[0]}set onstart(e){if(this._onstart!==null&&this.removeEventListener("start",this._onstart[1]),typeof e=="function"){const n=e.bind(this);this.addEventListener("start",n),this._onstart=[e,n]}else this._onstart=null}get onstop(){return this._onstop===null?this._onstop:this._onstop[0]}set onstop(e){if(this._onstop!==null&&this.removeEventListener("stop",this._onstop[1]),typeof e=="function"){const n=e.bind(this);this.addEventListener("stop",n),this._onstop=[e,n]}else this._onstop=null}get state(){return this._internalMediaRecorder.state}pause(){return this._internalMediaRecorder.pause()}resume(){return this._internalMediaRecorder.resume()}start(e){return this._internalMediaRecorder.start(e)}stop(){return this._internalMediaRecorder.stop()}static isTypeSupported(e){return r!==null&&r.isTypeSupported!==void 0&&r.isTypeSupported(e)||a.some(n=>n.test(e))}},le=t=>t!==null&&t.BlobEvent!==void 0?t.BlobEvent:null,ue=t=>t===null||t.MediaRecorder===void 0?null:t.MediaRecorder,ce=t=>(o,i,s)=>{const a=new Map,l=new WeakMap,r=new WeakMap,c=[],e=new o(i,s),n=new WeakMap;return e.addEventListener("stop",({isTrusted:u})=>{u&&setTimeout(()=>c.shift())}),e.addEventListener=(u=>(p,f,R)=>{let d=f;if(typeof f=="function")if(p==="dataavailable"){const h=[];d=E=>{const[[v,b]=[!1,!1]]=c;v&&!b?h.push(E):f.call(e,E)},a.set(f,h),l.set(f,d)}else p==="error"?(d=h=>{h instanceof ErrorEvent?f.call(e,h):f.call(e,new ErrorEvent("error",{error:h.error}))},r.set(f,d)):p==="stop"&&(d=h=>{for(const[E,v]of a.entries())if(v.length>0){const[b]=v;v.length>1&&Object.defineProperty(b,"data",{value:new Blob(v.map(({data:L})=>L),{type:b.data.type})}),v.length=0,E.call(e,b)}f.call(e,h)},n.set(f,d));return u.call(e,p,d,R)})(e.addEventListener),e.removeEventListener=(u=>(p,f,R)=>{let d=f;if(typeof f=="function"){if(p==="dataavailable"){a.delete(f);const h=l.get(f);h!==void 0&&(d=h)}else if(p==="error"){const h=r.get(f);h!==void 0&&(d=h)}else if(p==="stop"){const h=n.get(f);h!==void 0&&(d=h)}}return u.call(e,p,d,R)})(e.removeEventListener),e.start=(u=>p=>{if(s.mimeType!==void 0&&s.mimeType.startsWith("audio/")&&i.getVideoTracks().length>0)throw t();return e.state==="inactive"&&c.push([p!==void 0,!0]),p===void 0?u.call(e):u.call(e,p)})(e.start),e.stop=(u=>()=>{e.state!=="inactive"&&(c[0][1]=!1),u.call(e)})(e.stop),e},C=()=>{try{return new DOMException("","NotSupportedError")}catch(t){return t.code=9,t.name="NotSupportedError",t}},de=t=>(o,i,s,a=2)=>{const l=t(o,i);if(l===null)return l;const{length:r,value:c}=l;if(s==="master")return{content:null,length:r};if(i+r+c>o.byteLength)return null;if(s==="binary"){const e=(c/Float32Array.BYTES_PER_ELEMENT-1)/a,n=Array.from({length:a},()=>new Float32Array(e));for(let u=0;u<e;u+=1){const p=u*a+1;for(let f=0;f<a;f+=1)n[f][u]=o.getFloat32(i+r+(p+f)*Float32Array.BYTES_PER_ELEMENT,!0)}return{content:n,length:r+c}}return{content:null,length:r+c}},fe=t=>(o,i)=>{const s=t(o,i);if(s===null)return s;const{length:a,value:l}=s;return l===35?{length:a,type:"binary"}:l===46||l===97||l===88713574||l===106212971||l===139690087||l===172351395||l===256095861?{length:a,type:"master"}:{length:a,type:"unknown"}},he=t=>(o,i)=>{const s=t(o,i);if(s===null)return s;const a=i+Math.floor((s-1)/8);if(a+s>o.byteLength)return null;let r=o.getUint8(a)&(1<<8-s%8)-1;for(let c=1;c<s;c+=1)r=(r<<8)+o.getUint8(a+c);return{length:s,value:r}},Y="Missing AudioWorklet support. Maybe this is not running in a secure context.",pe=async(t,o,i,s,a)=>{const{encoderInstanceId:l,port:r}=await V(a,o.sampleRate);if(q===void 0)throw new Error(Y);const c=new X(o,{buffer:t}),e=new Z(o,{mediaStream:s}),n=J(q,o,{channelCount:i});return{audioBufferSourceNode:c,encoderInstanceId:l,mediaStreamAudioSourceNode:e,port:r,recorderAudioWorkletNode:n}},Ee=(t,o,i,s)=>(a,l,r)=>{var c;const e=(c=l.getAudioTracks()[0])===null||c===void 0?void 0:c.getSettings().sampleRate,n=new K({latencyHint:"playback",sampleRate:e}),u=Math.max(1024,Math.ceil(n.baseLatency*n.sampleRate)),p=new Q({length:u,sampleRate:n.sampleRate}),f=[],R=$(g=>{if(U===void 0)throw new Error(Y);return U(n,g)});let d=null,h=null,E=null,v=null,b=!0;const L=g=>{a.dispatchEvent(t("dataavailable",{data:new Blob(g,{type:r})}))},P=async(g,m)=>{const _=await F(g,m);E===null?f.push(..._):(L(_),v=P(g,m))},S=()=>(b=!0,n.resume()),D=()=>{E!==null&&(d!==null&&(l.removeEventListener("addtrack",d),l.removeEventListener("removetrack",d)),h!==null&&clearTimeout(h),E.then(async({encoderInstanceId:g,mediaStreamAudioSourceNode:m,recorderAudioWorkletNode:_})=>{v!==null&&(v.catch(()=>{}),v=null),await _.stop(),m.disconnect(_);const A=await F(g,null);E===null&&await T(),L([...f,...A]),f.length=0,a.dispatchEvent(new Event("stop"))}),E=null)},T=()=>(b=!1,n.suspend());return T(),{get mimeType(){return r},get state(){return E===null?"inactive":b?"recording":"paused"},pause(){if(E===null)throw i();b&&(T(),a.dispatchEvent(new Event("pause")))},resume(){if(E===null)throw i();b||(S(),a.dispatchEvent(new Event("resume")))},start(g){var m;if(E!==null)throw i();if(l.getVideoTracks().length>0)throw s();a.dispatchEvent(new Event("start"));const _=l.getAudioTracks(),A=_.length===0?2:(m=_[0].getSettings().channelCount)!==null&&m!==void 0?m:2;E=Promise.all([S(),R.then(()=>pe(p,n,A,l,r))]).then(async([,{audioBufferSourceNode:w,encoderInstanceId:y,mediaStreamAudioSourceNode:W,port:x,recorderAudioWorkletNode:k}])=>(W.connect(k),await new Promise(N=>{w.onended=N,w.connect(k),w.start(n.currentTime+u/n.sampleRate)}),w.disconnect(k),await k.record(x),g!==void 0&&(v=P(y,g)),{encoderInstanceId:y,mediaStreamAudioSourceNode:W,recorderAudioWorkletNode:k}));const M=l.getTracks();d=()=>{D(),a.dispatchEvent(new ErrorEvent("error",{error:o()}))},l.addEventListener("addtrack",d),l.addEventListener("removetrack",d),h=setInterval(()=>{const w=l.getTracks();(w.length!==M.length||w.some((y,W)=>y!==M[W]))&&d!==null&&d()},1e3)},stop:D}},ve=(t,o,i)=>(s,a,l,r)=>{const c=[],e=new a(l,{mimeType:"audio/webm;codecs=pcm"});let n=null,u=()=>{};const p=d=>{s.dispatchEvent(t("dataavailable",{data:new Blob(d,{type:r})}))},f=async(d,h)=>{const E=await F(d,h);e.state==="inactive"?c.push(...E):(p(E),n=f(d,h))},R=()=>{e.state!=="inactive"&&(n!==null&&(n.catch(()=>{}),n=null),u(),u=()=>{},e.stop())};return e.addEventListener("error",d=>{R(),s.dispatchEvent(new ErrorEvent("error",{error:d.error}))}),e.addEventListener("pause",()=>s.dispatchEvent(new Event("pause"))),e.addEventListener("resume",()=>s.dispatchEvent(new Event("resume"))),e.addEventListener("start",()=>s.dispatchEvent(new Event("start"))),{get mimeType(){return r},get state(){return e.state},pause(){return e.pause()},resume(){return e.resume()},start(d){const[h]=l.getAudioTracks();if(h!==void 0&&e.state==="inactive"){const{channelCount:E,sampleRate:v}=h.getSettings();if(E===void 0)throw new Error("The channelCount is not defined.");if(v===void 0)throw new Error("The sampleRate is not defined.");let b=!1,L=!1,P=0,S=V(r,v);u=()=>{L=!0};const D=ee(e,"dataavailable")(({data:T})=>{P+=1;const g=T.arrayBuffer();S=S.then(async({dataView:m=null,elementType:_=null,encoderInstanceId:A,port:M})=>{const w=await g;P-=1;const y=m===null?new I([w]):new I([...m.buffers,w],m.byteOffset);if(!b&&e.state==="recording"&&!L){const B=i(y,0);if(B===null)return{dataView:y,elementType:_,encoderInstanceId:A,port:M};const{value:O}=B;if(O!==172351395)return{dataView:m,elementType:_,encoderInstanceId:A,port:M};b=!0}const{currentElementType:W,offset:x,contents:k}=o(y,_,E),N=x<y.byteLength?new I(y.buffers,y.byteOffset+x):null;return k.forEach(B=>M.postMessage(B,B.map(({buffer:O})=>O))),P===0&&(e.state==="inactive"||L)&&(F(A,null).then(B=>{p([...c,...B]),c.length=0,s.dispatchEvent(new Event("stop"))}),M.postMessage([]),M.close(),D()),{dataView:N,elementType:W,encoderInstanceId:A,port:M}})});d!==void 0&&S.then(({encoderInstanceId:T})=>{L||(n=f(T,d))})}e.start(100)},stop:R}},be=()=>typeof window>"u"?null:window,G=(t,o)=>{if(o>=t.byteLength)return null;const i=t.getUint8(o);if(i>127)return 1;if(i>63)return 2;if(i>31)return 3;if(i>15)return 4;if(i>7)return 5;if(i>3)return 6;if(i>1)return 7;if(i>0)return 8;const s=G(t,o+1);return s===null?null:s+8},ge=(t,o)=>i=>{const s={value:t};return Object.defineProperties(i,{currentTarget:s,target:s}),typeof o=="function"?o.call(t,i):o.handleEvent.call(t,i)},me=[],j=be(),_e=le(j),H=te(_e),ye=Ee(H,oe,ie,C),z=he(G),we=de(z),Le=fe(z),Me=ne(we,Le),Re=ve(H,Me,z),Ae=se(j),Te=ue(j),Fe=ae(ce(C),C,ye,Re,me,re(Ae,ge),Te);export{Fe as m};
//# sourceMappingURL=extendable-media-recorder-DiYIi_eR.js.map
